#!/usr/bin/env bash
#
# Script to toggle the input source of a DDC/CI compatible monitor using ddcutil.
#
# Prerequisites: ddcutil must be installed.
#

# Monitor model string (must exactly match ddcutil's output for -l/--display)
MONITOR_MODEL='DELL U3821DW'

# VCP Code for Input Select
VCP_CODE=0x60

# VCP values for the two inputs to toggle between
INPUT_DP_1=0x0f # Example: DisplayPort (DP)
INPUT_USB_C=0x1b # Example: USB-C/KVM

# Check if ddcutil is installed and store its path
DDCUTIL_CMD=$(command -v ddcutil) || { echo "ERROR: 'ddcutil' command not found. Aborting." >&2; exit 1; }

# Get current input value (VCP 0x60)
echo "Getting current input for monitor: ${MONITOR_MODEL}" >&2
CURRENT_VCP=$(${DDCUTIL_CMD} -l "${MONITOR_MODEL}" getvcp "${VCP_CODE}" \
    | sed -n "s/.*(sl=\(.*\))/\1/p")

if [ -z "${CURRENT_VCP}" ]; then
    echo "ERROR: Failed to retrieve current VCP code for ${MONITOR_MODEL}. Check ddcutil permissions/connection." >&2
    exit 1
fi

# Determine the target input value
TARGET_VCP=""
TARGET_NAME=""
case "${CURRENT_VCP}" in
    "${INPUT_USB_C}")
        TARGET_VCP="${INPUT_DP_1}"
        TARGET_NAME="DisplayPort (VCP ${TARGET_VCP})"
        ;;

    "${INPUT_DP_1}")
        TARGET_VCP="${INPUT_USB_C}"
        TARGET_NAME="USB-C/KVM (VCP ${TARGET_VCP})"
        ;;

    *)
        echo "ERROR: Current input VCP code '${CURRENT_VCP}' is unknown. Cannot toggle." >&2
        exit 1
        ;;
esac

# Set the new input
echo "Switching input to: ${TARGET_NAME}" >&2
${DDCUTIL_CMD} -l "${MONITOR_MODEL}" setvcp "${VCP_CODE}" "${TARGET_VCP}"

echo "Input switched successfully." >&2
