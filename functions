#!/usr/bin/env bash

#
# Variables
#

home_dir=${HOME}
config_dir=${HOME}/.home
distro=$(grep '^ID' /etc/os-release | cut -d'=' -f2 | tr '[:upper:]' '[:lower:]')
release=$(grep '^VERSION_ID' /etc/os-release | cut -d'=' -f2)
marker="~GENERATED BY DOTFILES SETUP~"

: "${XDG_PICTURES_DIR:=${HOME}/Private/Pictures}"

#
# Functions
#

#
# Simple ask function
# Source http://djm.me/ask
#

ask() {
	local prompt default REPLY

	while true; do

		if [ "${2:-}" = "Y" ]; then
			prompt="Y/n"
			default=Y
		elif [ "${2:-}" = "N" ]; then
			prompt="y/N"
			default=N
		else
			prompt="y/n"
			default=
		fi

		# Ask the question (not using "read -p" as it uses stderr not stdout)
		echo -n "[version: ${distro}@${release}] --> $1 [$prompt] "

		# Read the answer (use /dev/tty in case stdin is redirected from somewhere else)
		read REPLY < /dev/tty

		# Default?
		if [ -z "$REPLY" ]; then
			REPLY=$default
		fi

		# Check if the reply is valid
		case "$REPLY" in
			Y* | y*) return 0 ;;
			N* | n*) return 1 ;;
		esac

	done
}

checkProfile() {
	if [ ! -f ${home_dir}/.profile ]; then
		touch ${home_dir}/.profile
	fi

	if [ -d ${config_dir}/.profile.d ]; then

		if ! grep -q "${marker}" "${home_dir}/.profile"; then
			tee -a ${home_dir}/.profile <<- EOF
				#####
				# DO NOT REMOVE THIS LINE. ${marker}
				if [ -d ${config_dir}/.profile.d ]; then
				    for file in ${config_dir}/.profile.d/.profile-* ; do
				        . \$file
				    done
				    unset file
				fi
			EOF
		fi

	fi
}

checkBashProfile() {
	if [ ! -f ${home_dir}/.bash_profile ]; then
		touch ${home_dir}/.bash_profile
	fi
	if [ -d ${config_dir}/.bash_profile.d ]; then
		if ! grep -q "${marker}" "${home_dir}/.bash_profile"; then
			tee -a ${home_dir}/.bash_profile <<- EOF
				#####
				# DO NOT REMOVE THIS LINE. ${marker}
				if [ -d ${config_dir}/.bash_profile.d ]; then
				    for file in ${config_dir}/.bash_profile.d/.bash_profile-* ; do
				        . \$file
				    done
				    unset file
				fi
			EOF
		fi

	fi
}

checkBashrc() {
	if [ ! -f ${home_dir}/.bashrc ]; then
		touch ${home_dir}/.bashrc
	fi

	if [ -d ${config_dir}/.bashrc.d ]; then

		if ! grep -q "${marker}" "${home_dir}/.bashrc"; then
			tee -a ${home_dir}/.bashrc <<- EOF
				#####
				# DO NOT REMOVE THIS LINE. ${marker}
				if [ -d ${config_dir}/.bashrc.d ]; then
				    for file in ${config_dir}/.bashrc.d/.bashrc-* ; do
				        . \$file
				    done
				    unset file
				fi
			EOF
		fi

	fi
}

checkXresources() {
	if [ ! -f ${home_dir}/.Xresources ]; then
		touch ${home_dir}/.Xresources
	fi

	if [ -d ${config_dir}/.Xresources.d ]; then

		if ! grep -q "${marker}" "${home_dir}/.Xresources"; then
			# Adding marker
			tee -a ${home_dir}/.Xresources <<- EOF
				! ####
				! DO NOT REMOVE THIS LINE. ${marker}
			EOF
		fi

		# Check that all custom files are included
		for file in ${config_dir}/.Xresources.d/.Xresources*; do
			if ! grep -q "${file}" "${home_dir}/.Xresources"; then
				echo "#include \"${file}\"" >> ${home_dir}/.Xresources
			fi
		done

		# Reloading X resources
		xrdb ${home_dir}/.Xresources

	fi
}

checkAllResources() {
	checkProfile
	checkBashProfile
	checkBashrc
	checkXresources
}
